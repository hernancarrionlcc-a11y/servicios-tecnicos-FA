<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FA Insumos - Sistema T√©cnico</title>
    <style>
        body { font-family: sans-serif; background: #eef2f5; padding: 20px; color: #333; max-width: 600px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;}
        h2 { color: #2c3e50; margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 20px;}
        label { font-weight: bold; font-size: 14px; color: #555; display: block; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 15px; }
        textarea { resize: vertical; height: 80px; }
        .row { display: flex; gap: 10px; align-items: center; }
        .col { flex: 1; }
        button { width: 100%; background: #3498db; color: white; border: none; font-weight: bold; cursor: pointer; padding: 15px; font-size: 16px; border-radius: 5px; margin-top: 20px; transition: 0.3s; }
        button:hover { background: #2980b9; }
        .btn-update { background: #f39c12; } .btn-update:hover { background: #d68910; }
        .btn-search { background: #27ae60; } .btn-search:hover { background: #219150; }
        .btn-add { background: #95a5a6; padding: 8px; font-size: 14px; margin-top: 5px; }
        .btn-del { background: #e74c3c; width: auto; padding: 10px 15px; margin-top: 5px;}
        .btn-wsp { background: #25D366; color: white; margin-top: 15px; } .btn-wsp:hover { background: #1ebe5d; }
        .status-box { padding: 15px; border-radius: 5px; font-size: 15px; display: none; margin-top: 20px; background: #f8f9fa; border: 1px solid #ddd; }
        .nro-destacado { font-size: 28px; color: #c0392b; display: block; margin-top: 10px; text-align: center; font-weight: bold;}
        .historial-texto { white-space: pre-wrap; background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 13px; margin-top: 10px;}
        .finanzas-box { background: #e8f8f5; border: 1px solid #1abc9c; padding: 10px; margin-top: 10px; border-radius: 5px; }
        
        @media print {
            body * { visibility: hidden; }
            #ticketImpresion, #ticketImpresion * { visibility: visible; }
            #ticketImpresion { position: absolute; left: 0; top: 0; width: 100%; max-width: 80mm; padding: 10px; font-family: monospace; font-size: 14px; background: white;}
            .card, button, input, select, textarea { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="ticketImpresion" style="display: none;">
        <div style="text-align: center; border-bottom: 2px dashed black; padding-bottom: 10px; margin-bottom: 10px;">
            <h2 style="margin: 0; font-size: 18px;">FA INSUMOS & SERVICIOS</h2>
            <p style="margin: 5px 0;">Comprobante de Ingreso</p>
        </div>
        <p style="margin: 5px 0;"><strong>Fecha:</strong> <span id="tFecha"></span></p>
        <p style="margin: 5px 0;"><strong>Orden N¬∫:</strong> <span id="tNro" style="font-size: 18px; font-weight: bold;"></span></p>
        <p style="margin: 5px 0;"><strong>Equipo:</strong> <span id="tEquipo"></span></p>
        <p style="margin: 5px 0;"><strong>Falla / Obs:</strong> <span id="tFalla"></span></p>
        <hr style="border-top: 1px dashed black; margin: 10px 0;">
        <p style="margin: 5px 0;"><strong>Presupuesto:</strong><br><pre id="tDetalle" style="font-family: monospace; font-size: 13px; margin: 5px 0; white-space: pre-wrap;"></pre></p>
        <p style="margin: 5px 0;"><strong>Total:</strong> $<span id="tTotal"></span></p>
        <p style="margin: 5px 0;"><strong>Se√±a:</strong> $<span id="tSena"></span></p>
        <p style="text-align: center; margin-top: 20px; border-top: 2px dashed black; padding-top: 10px;">¬°Gracias por confiar en nosotros!</p>
    </div>

    <div class="card">
        <h2>üìù Nuevo Ingreso & Presupuesto</h2>
        <div class="row">
            <input type="text" id="cliente" class="col" placeholder="Nombre y Apellido" required>
            <input type="tel" id="telefono" class="col" placeholder="Tel√©fono (Ej: 264...)" required>
        </div>
        <div class="row">
            <select id="tipoEquipo" class="col">
                <option value="CPU">CPU</option><option value="NOTEBOOK">Notebook</option>
                <option value="IMPRESORA">Impresora</option><option value="MONITOR">Monitor</option>
                <option value="CELULAR">Celular</option><option value="OTRO">Otro</option>
            </select>
            <input type="text" id="modelo" class="col" placeholder="Marca / Modelo">
        </div>
        <input type="text" id="clave" placeholder="Clave / Patr√≥n (o 'Ninguna')">
        <textarea id="falla" placeholder="Falla / Observaciones..."></textarea>
        
        <label>Accesorios que deja el cliente</label>
        <div class="row">
            <div class="col"><small>Cargador</small><select id="cableCorriente"><option value="NO">NO</option><option value="SI">S√ç</option></select></div>
            <div class="col"><small>Cable USB</small><select id="cableDatos"><option value="NO">NO</option><option value="SI">S√ç</option></select></div>
        </div>
        <input type="text" id="otroAccesorio" placeholder="Otros accesorios (Funda, chip, cartuchos...)">
        
        <label style="color: #8e44ad; border-top: 1px solid #ccc; padding-top: 15px; margin-top: 15px;">üí∞ Cotizaci√≥n Inicial (Opcional)</label>
        <div id="contenedorItems">
            <div class="row item-cotizacion">
                <input type="text" class="col desc" placeholder="Ej: Revisi√≥n T√©cnica / Cambio SSD">
                <input type="number" class="col precio" placeholder="Precio ($)" onkeyup="calcularTotal()">
            </div>
        </div>
        <button class="btn-add" onclick="agregarItem()">+ A√±adir otro √≠tem</button>
        <div class="row" style="margin-top: 15px;">
            <div class="col"><label>Total ($)</label><input type="number" id="presTotal" readonly style="background: #eee; font-weight: bold;"></div>
            <div class="col"><label>Se√±a ($)</label><input type="number" id="presSena" value="0"></div>
        </div>

        <button id="btnIngresar" onclick="ejecutarAccion('ingresar')">Registrar Ingreso e Imprimir</button>
        <div id="mensajeIngreso" class="status-box"></div>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Actualizar Estado</h2>
        <input type="text" id="actNro" placeholder="Nro de Reparaci√≥n (Ej: 1 o 0001)">
        <select id="actEstado">
            <option value="En Revisi√≥n">En Revisi√≥n</option>
            <option value="Esperando Repuesto">Esperando Repuesto</option>
            <option value="Reparado">Reparado (Listo para entregar)</option>
            <option value="Sin Soluci√≥n">Sin Soluci√≥n</option>
            <option value="Entregado">Entregado</option>
        </select>
        <textarea id="actNota" placeholder="Agregar nota al historial (Opcional)..."></textarea>
        <button id="btnActualizar" class="btn-update" onclick="ejecutarAccion('actualizar')">Guardar Avance</button>
    </div>

    <div class="card">
        <h2>üîç Consultar Servicio</h2>
        <div class="row">
            <input type="text" id="consNro" class="col" placeholder="Nro de Reparaci√≥n o Nombre">
            <button id="btnConsultar" class="col btn-search" style="margin-top: 5px;" onclick="ejecutarAccion('consultar')">Buscar</button>
        </div>
        <div id="mensajeConsulta" class="status-box"></div>
    </div>

    <script>
        // ¬°REEMPLAZAR CON TU URL DEFINITIVA!
        const URL_API = "https://script.google.com/macros/s/AKfycbx205tJR-sW11Z1gzkwu1Ln_vcZSAmqstEwfMKteXAeTf35nHsOncciqOEqtLEAu-01/exec"; 

        function agregarItem() {
            const div = document.createElement('div');
            div.className = 'row item-cotizacion';
            div.innerHTML = `<input type="text" class="col desc" placeholder="Detalle"><input type="number" class="col precio" placeholder="Precio ($)" onkeyup="calcularTotal()"><button class="btn-del" onclick="this.parentElement.remove(); calcularTotal()">X</button>`;
            document.getElementById('contenedorItems').appendChild(div);
        }

        function calcularTotal() {
            let total = 0;
            document.querySelectorAll('.precio').forEach(input => { total += parseFloat(input.value) || 0; });
            document.getElementById('presTotal').value = total;
        }

        function abrirWhatsApp(telefono, cliente, equipo, estado, saldo) {
            let numeroLimpio = telefono.replace(/\D/g,'');
            if (!numeroLimpio.startsWith("549")) numeroLimpio = "549" + numeroLimpio;
            let texto = `Hola ${cliente}! Te escribimos de FA Insumos & Servicios. Te avisamos que tu equipo (${equipo}) se encuentra en estado: *${estado}*.`;
            if (saldo > 0) texto += ` El saldo a abonar es de $${saldo}.`;
            texto += ` ¬°Cualquier consulta estamos a disposici√≥n!`;
            window.open(`https://wa.me/${numeroLimpio}?text=${encodeURIComponent(texto)}`, '_blank');
        }

        async function ejecutarAccion(tipo) {
            let idBoton = tipo === 'ingresar' ? 'btnIngresar' : (tipo === 'actualizar' ? 'btnActualizar' : 'btnConsultar');
            const btn = document.getElementById(idBoton);
            const textoOriginal = btn.innerText;
            btn.disabled = true; btn.innerText = "Procesando...";

            let datos = { accion: tipo };

            if (tipo === 'ingresar') {
                datos.cliente = document.getElementById('cliente').value;
                datos.telefono = document.getElementById('telefono').value;
                datos.tipoEquipo = document.getElementById('tipoEquipo').value;
                datos.modelo = document.getElementById('modelo').value;
                datos.clave = document.getElementById('clave').value || "Ninguna";
                datos.falla = document.getElementById('falla').value || "Sin observaciones";
                datos.cableCorriente = document.getElementById('cableCorriente').value;
                datos.cableDatos = document.getElementById('cableDatos').value;
                datos.otroAccesorio = document.getElementById('otroAccesorio').value || "Ninguno";
                
                datos.total = document.getElementById('presTotal').value || 0;
                datos.sena = document.getElementById('presSena').value || 0;
                let detalleStr = "";
                document.querySelectorAll('.item-cotizacion').forEach(item => {
                    let desc = item.querySelector('.desc').value; let prec = item.querySelector('.precio').value;
                    if(desc && prec) detalleStr += `- ${desc}: $${prec}\n`;
                });
                datos.detalle = detalleStr || "Sin cotizar";

                if(!datos.cliente || !datos.telefono) { alert("Nombre y tel√©fono obligatorios."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            } 
            else if (tipo === 'actualizar') {
                datos.id = document.getElementById('actNro').value;
                datos.estado = document.getElementById('actEstado').value;
                datos.nota = document.getElementById('actNota').value;
                if(!datos.id) { alert("Ingresa Nro."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            } 
            else if (tipo === 'consultar') {
                datos.id = document.getElementById('consNro').value;
                if(!datos.id) { alert("Ingresa Nro o Nombre."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            }

            try {
                const response = await fetch(URL_API, { method: 'POST', body: JSON.stringify(datos) });
                const res = await response.json();
                
                if (res.error) alert(res.error);
                else if (tipo === 'ingresar') {
                    document.getElementById('tFecha').innerText = res.fecha;
                    document.getElementById('tNro').innerText = res.nroAsignado;
                    document.getElementById('tEquipo').innerText = datos.tipoEquipo + " " + datos.modelo;
                    document.getElementById('tFalla').innerText = datos.falla;
                    document.getElementById('tDetalle').innerText = datos.detalle;
                    document.getElementById('tTotal').innerText = datos.total;
                    document.getElementById('tSena').innerText = datos.sena;
                    
                    const caja = document.getElementById('mensajeIngreso');
                    caja.style.display = 'block'; caja.style.background = '#d4edda';
                    caja.innerHTML = `‚úÖ ¬°Ingresado!<br><span class="nro-destacado">N¬∫ ${res.nroAsignado}</span>`;
                    
                    document.getElementById('ticketImpresion').style.display = 'block';
                    window.print();
                    document.getElementById('ticketImpresion').style.display = 'none';

                    document.querySelectorAll('input[type="text"], input[type="tel"], textarea').forEach(el => el.value = '');
                    document.querySelectorAll('.item-cotizacion').forEach((el, index) => { if(index > 0) el.remove(); });
                    document.getElementById('presTotal').value = '';
                    document.getElementById('presSena').value = '0';
                    document.getElementById('cableCorriente').value = "NO";
                    document.getElementById('cableDatos').value = "NO";

                } else if (tipo === 'actualizar') {
                    alert(res.mensaje);
                    document.getElementById('actNro').value = '';
                    document.getElementById('actNota').value = '';
                } else if (tipo === 'consultar') {
                    const caja = document.getElementById('mensajeConsulta');
                    caja.style.display = 'block';
                    
                    let saldo = res.total - res.sena;
                    let finanzasHTML = "";
                    if(res.total > 0) {
                        finanzasHTML = `<div class="finanzas-box">
                            <strong>Cotizaci√≥n:</strong><br><pre style="margin:5px 0; font-family:sans-serif;">${res.detalle}</pre><hr style="border:0; border-top:1px solid #1abc9c;">
                            <b>Total:</b> $${res.total} | <b>Se√±a:</b> $${res.sena} <br>
                            <b style="color:#c0392b; font-size:16px;">Restante a Pagar: $${saldo}</b></div>`;
                    }

                    // L√≥gica para mostrar la etiqueta si el equipo es un historial viejo ("Entregado")
                    let badgeArchivado = res.estado === "Entregado" 
                        ? `<div style="background:#f39c12; color:white; padding:5px; text-align:center; font-size:12px; margin-bottom:10px; border-radius:3px; font-weight:bold;">‚ö†Ô∏è ESTE EQUIPO YA FUE ENTREGADO AL CLIENTE</div>` 
                        : ``;

                    caja.innerHTML = `
                        ${badgeArchivado}
                        <div style="background: #34495e; color: white; padding: 5px; text-align: center; border-radius: 3px; margin-bottom: 10px;">
                            <b>REPARACI√ìN N¬∫ ${res.nroAsignado}</b>
                        </div>
                        <b>Cliente:</b> ${res.cliente} <br>
                        <b>Equipo:</b> ${res.equipo} <br>
                        <b>Estado Actual:</b> <span style="color:#d32f2f; font-weight:bold;">${res.estado}</span> <br>
                        ${finanzasHTML}
                        <div class="historial-texto">${res.historial}</div>
                        <button class="btn-wsp" onclick="abrirWhatsApp('${res.telefono}', '${res.cliente}', '${res.equipo}', '${res.estado}', ${saldo})">üì≤ Avisar al Cliente por WhatsApp</button>
                    `;
                }
            } catch (error) {
                alert("Error de conexi√≥n. Revisa la URL.");
            } finally {
                btn.disabled = false; btn.innerText = textoOriginal;
            }
        }
    </script>
</body>
</html>