<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FA Insumos - Sistema T√©cnico</title>
    <style>
        body { font-family: sans-serif; background: #eef2f5; padding: 20px; color: #333; max-width: 600px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;}
        h2 { color: #2c3e50; margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 20px;}
        label { font-weight: bold; font-size: 14px; color: #555; display: block; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 15px; }
        textarea { resize: vertical; height: 80px; }
        .row { display: flex; gap: 10px; align-items: center; }
        .col { flex: 1; }
        button { width: 100%; background: #3498db; color: white; border: none; font-weight: bold; cursor: pointer; padding: 15px; font-size: 16px; border-radius: 5px; margin-top: 20px; transition: 0.3s; }
        button:hover { background: #2980b9; }
        .btn-update { background: #f39c12; } .btn-update:hover { background: #d68910; }
        .btn-search { background: #27ae60; } .btn-search:hover { background: #219150; }
        .btn-add { background: #95a5a6; padding: 8px; font-size: 14px; margin-top: 5px; }
        .btn-del { background: #e74c3c; width: auto; padding: 10px 15px; margin-top: 5px;}
        .btn-wsp { background: #25D366; color: white; margin-top: 15px; } .btn-wsp:hover { background: #1ebe5d; }
        .status-box { padding: 15px; border-radius: 5px; font-size: 15px; display: none; margin-top: 20px; background: #f8f9fa; border: 1px solid #ddd; }
        .nro-destacado { font-size: 28px; color: #c0392b; display: block; margin-top: 10px; text-align: center; font-weight: bold;}
        .historial-texto { white-space: pre-wrap; background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 13px; margin-top: 10px;}
        .finanzas-box { background: #e8f8f5; border: 1px solid #1abc9c; padding: 10px; margin-top: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üìù Nuevo Ingreso</h2>
        <div class="row">
            <input type="text" id="cliente" class="col" placeholder="Nombre y Apellido" required>
            <input type="tel" id="telefono" class="col" placeholder="Tel√©fono (Ej: 264...)" required>
        </div>
        <div class="row">
            <select id="tipoEquipo" class="col">
                <option value="CPU">CPU</option><option value="NOTEBOOK">Notebook</option>
                <option value="IMPRESORA">Impresora</option><option value="MONITOR">Monitor</option>
                <option value="CELULAR">Celular</option><option value="OTRO">Otro</option>
            </select>
            <input type="text" id="modelo" class="col" placeholder="Marca / Modelo">
        </div>
        <input type="text" id="clave" placeholder="Clave / Patr√≥n (o 'Ninguna')">
        <textarea id="falla" placeholder="Falla / Observaciones..."></textarea>
        <div class="row">
            <div class="col"><small>Cargador</small><select id="cableCorriente"><option value="NO">NO</option><option value="SI">S√ç</option></select></div>
            <div class="col"><small>Cable USB</small><select id="cableDatos"><option value="NO">NO</option><option value="SI">S√ç</option></select></div>
        </div>
        <button id="btnIngresar" onclick="ejecutarAccion('ingresar')">Registrar Ingreso</button>
        <div id="mensajeIngreso" class="status-box"></div>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Actualizar Estado</h2>
        <input type="number" id="actNro" placeholder="Nro de Reparaci√≥n">
        <select id="actEstado">
            <option value="En Revisi√≥n">En Revisi√≥n</option>
            <option value="Esperando Repuesto">Esperando Repuesto</option>
            <option value="Reparado">Reparado (Listo para entregar)</option>
            <option value="Sin Soluci√≥n">Sin Soluci√≥n</option>
            <option value="Entregado">Entregado</option>
        </select>
        <textarea id="actNota" placeholder="Agregar nota al historial (Opcional)..."></textarea>
        <button id="btnActualizar" class="btn-update" onclick="ejecutarAccion('actualizar')">Guardar Avance</button>
    </div>

    <div class="card">
        <h2>üí∞ Cargar Presupuesto</h2>
        <input type="number" id="presNro" placeholder="Nro de Reparaci√≥n">
        <label>Detalle de Cotizaci√≥n</label>
        <div id="contenedorItems">
            <div class="row item-cotizacion">
                <input type="text" class="col desc" placeholder="Ej: Disco SSD">
                <input type="number" class="col precio" placeholder="Precio ($)" onkeyup="calcularTotal()">
            </div>
        </div>
        <button class="btn-add" onclick="agregarItem()">+ A√±adir otro √≠tem</button>
        <div class="row" style="margin-top: 15px;">
            <div class="col"><label>Total ($)</label><input type="number" id="presTotal" readonly style="background: #eee; font-weight: bold;"></div>
            <div class="col"><label>Se√±a ($)</label><input type="number" id="presSena" value="0"></div>
        </div>
        <button id="btnPresupuesto" class="btn-update" style="background:#8e44ad;" onclick="ejecutarAccion('presupuestar')">Guardar Cotizaci√≥n</button>
    </div>

    <div class="card">
        <h2>üîç Consultar Servicio</h2>
        <div class="row">
            <input type="number" id="consNro" class="col" placeholder="Nro de Reparaci√≥n">
            <button id="btnConsultar" class="col btn-search" style="margin-top: 5px;" onclick="ejecutarAccion('consultar')">Buscar</button>
        </div>
        <div id="mensajeConsulta" class="status-box"></div>
    </div>

    <script>
        // ¬°REEMPLAZAR CON TU URL!
        const URL_API = "https://script.google.com/macros/s/AKfycbx205tJR-sW11Z1gzkwu1Ln_vcZSAmqstEwfMKteXAeTf35nHsOncciqOEqtLEAu-01/exec"; 

        function agregarItem() {
            const div = document.createElement('div');
            div.className = 'row item-cotizacion';
            div.innerHTML = `<input type="text" class="col desc" placeholder="Detalle"><input type="number" class="col precio" placeholder="Precio ($)" onkeyup="calcularTotal()"><button class="btn-del" onclick="this.parentElement.remove(); calcularTotal()">X</button>`;
            document.getElementById('contenedorItems').appendChild(div);
        }

        function calcularTotal() {
            let total = 0;
            document.querySelectorAll('.precio').forEach(input => { total += parseFloat(input.value) || 0; });
            document.getElementById('presTotal').value = total;
        }

        function abrirWhatsApp(telefono, cliente, equipo, estado, saldo) {
            // Limpia el n√∫mero (quita espacios, guiones, etc)
            let numeroLimpio = telefono.replace(/\D/g,'');
            // Si el n√∫mero no arranca con 549, se lo agregamos por defecto (formato Argentina)
            if (!numeroLimpio.startsWith("549")) numeroLimpio = "549" + numeroLimpio;
            
            let texto = `Hola ${cliente}! Te escribimos del Servicio T√©cnico. Te avisamos que tu equipo (${equipo}) se encuentra en estado: *${estado}*.`;
            if (saldo > 0) texto += ` El saldo a abonar es de $${saldo}.`;
            texto += ` ¬°Cualquier consulta estamos a disposici√≥n!`;
            
            let url = `https://wa.me/${numeroLimpio}?text=${encodeURIComponent(texto)}`;
            window.open(url, '_blank');
        }

        async function ejecutarAccion(tipo) {
            let idBoton = tipo === 'ingresar' ? 'btnIngresar' : (tipo === 'actualizar' ? 'btnActualizar' : (tipo === 'presupuestar' ? 'btnPresupuesto' : 'btnConsultar'));
            const btn = document.getElementById(idBoton);
            const textoOriginal = btn.innerText;
            btn.disabled = true; btn.innerText = "Procesando...";

            let datos = { accion: tipo };

            if (tipo === 'ingresar') {
                datos.cliente = document.getElementById('cliente').value;
                datos.telefono = document.getElementById('telefono').value;
                datos.tipoEquipo = document.getElementById('tipoEquipo').value;
                datos.modelo = document.getElementById('modelo').value;
                datos.clave = document.getElementById('clave').value || "Ninguna";
                datos.falla = document.getElementById('falla').value;
                datos.cableCorriente = document.getElementById('cableCorriente').value;
                datos.cableDatos = document.getElementById('cableDatos').value;
                if(!datos.cliente || !datos.telefono) { alert("Nombre y tel√©fono obligatorios."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            } 
            else if (tipo === 'actualizar') {
                datos.id = document.getElementById('actNro').value;
                datos.estado = document.getElementById('actEstado').value;
                datos.nota = document.getElementById('actNota').value;
                if(!datos.id) { alert("Ingresa Nro."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            } 
            else if (tipo === 'presupuestar') {
                datos.id = document.getElementById('presNro').value;
                datos.total = document.getElementById('presTotal').value || 0;
                datos.sena = document.getElementById('presSena').value || 0;
                let detalleStr = "";
                document.querySelectorAll('.item-cotizacion').forEach(item => {
                    let desc = item.querySelector('.desc').value; let prec = item.querySelector('.precio').value;
                    if(desc && prec) detalleStr += `- ${desc}: $${prec}\n`;
                });
                datos.detalle = detalleStr || "Sin detalle";
                if(!datos.id) { alert("Ingresa Nro."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            }
            else if (tipo === 'consultar') {
                datos.id = document.getElementById('consNro').value;
                if(!datos.id) { alert("Ingresa Nro."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            }

            try {
                const response = await fetch(URL_API, { method: 'POST', body: JSON.stringify(datos) });
                const res = await response.json();
                
                if (res.error) alert(res.error);
                else if (tipo === 'ingresar') {
                    const caja = document.getElementById('mensajeIngreso');
                    caja.style.display = 'block'; caja.style.background = '#d4edda';
                    caja.innerHTML = `‚úÖ ¬°Ingresado!<br><span class="nro-destacado">N¬∫ ${res.nroAsignado}</span>`;
                    document.querySelectorAll('input[type="text"], input[type="tel"], textarea').forEach(el => el.value = '');
                } else if (tipo === 'actualizar' || tipo === 'presupuestar') {
                    alert(res.mensaje);
                    document.querySelectorAll('input[type="number"], textarea').forEach(el => el.value = '');
                } else if (tipo === 'consultar') {
                    const caja = document.getElementById('mensajeConsulta');
                    caja.style.display = 'block';
                    
                    let saldo = res.total - res.sena;
                    let finanzasHTML = "";
                    if(res.total > 0) {
                        finanzasHTML = `<div class="finanzas-box">
                            <strong>Cotizaci√≥n:</strong><br><pre style="margin:5px 0; font-family:sans-serif;">${res.detalle}</pre><hr style="border:0; border-top:1px solid #1abc9c;">
                            <b>Total:</b> $${res.total} | <b>Se√±a:</b> $${res.sena} <br>
                            <b style="color:#c0392b; font-size:16px;">Restante a Pagar: $${saldo}</b></div>`;
                    }

                    caja.innerHTML = `
                        <b>Cliente:</b> ${res.cliente} <br>
                        <b>Equipo:</b> ${res.equipo} <br>
                        <b>Estado Actual:</b> <span style="color:#d32f2f; font-weight:bold;">${res.estado}</span> <br>
                        ${finanzasHTML}
                        <div class="historial-texto">${res.historial}</div>
                        <button class="btn-wsp" onclick="abrirWhatsApp('${res.telefono}', '${res.cliente}', '${res.equipo}', '${res.estado}', ${saldo})">üì≤ Avisar al Cliente por WhatsApp</button>
                    `;
                }
            } catch (error) {
                alert("Error de conexi√≥n. Revisa la URL.");
            } finally {
                btn.disabled = false; btn.innerText = textoOriginal;
            }
        }
    </script>
</body>
</html>