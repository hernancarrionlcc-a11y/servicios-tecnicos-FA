<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FA Insumos & Servicios</title>
    
    <link rel="icon" href="LOGO FA.jpg" type="image/jpeg">
    
    <style>
        body { font-family: sans-serif; background: #eef2f5; padding: 20px; color: #333; max-width: 600px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;}
        h2 { color: #2c3e50; margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 20px;}
        label { font-weight: bold; font-size: 14px; color: #555; display: block; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 15px; }
        textarea { resize: vertical; height: 80px; }
        .row { display: flex; gap: 10px; align-items: center; }
        .col { flex: 1; }
        button { width: 100%; background: #3498db; color: white; border: none; font-weight: bold; cursor: pointer; padding: 15px; font-size: 16px; border-radius: 5px; margin-top: 20px; transition: 0.3s; }
        button:hover { background: #2980b9; }
        .btn-update { background: #f39c12; } .btn-update:hover { background: #d68910; }
        .btn-search { background: #27ae60; } .btn-search:hover { background: #219150; }
        .btn-add { background: #95a5a6; padding: 8px; font-size: 14px; margin-top: 5px; }
        .btn-del { background: #e74c3c; width: auto; padding: 10px 15px; margin-top: 5px;}
        .status-box { padding: 15px; border-radius: 5px; font-size: 15px; display: none; margin-top: 20px; background: #f8f9fa; border: 1px solid #ddd; }
        .nro-destacado { font-size: 28px; color: #c0392b; display: block; margin-top: 10px; text-align: center; font-weight: bold;}
        .historial-texto { white-space: pre-wrap; background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 13px; margin-top: 10px;}
        .finanzas-box { background: #e8f8f5; border: 1px solid #1abc9c; padding: 10px; margin-top: 10px; border-radius: 5px; }
        
        /* ESTILOS DEL PATR√ìN DE DESBLOQUEO */
        .pattern-container { text-align: center; margin-top: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        canvas { background: white; border-radius: 10px; touch-action: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); cursor: crosshair; }
        .btn-clear-pattern { background: #e74c3c; padding: 8px; font-size: 14px; margin-top: 10px; width: auto; display: inline-block; }

        /* ESTILOS EXCLUSIVOS PARA LA IMPRESORA (TAMA√ëO A6) */
        @media print {
            @page { 
                size: A6 portrait; 
                margin: 0; 
            }
            body { margin: 0; padding: 0; background: white; }
            body * { visibility: hidden; }
            #ticketImpresion, #ticketImpresion * { visibility: visible; }
            #ticketImpresion { 
                position: absolute; left: 0; top: 0; width: 100%; height: 100%; max-width: none;
                padding: 12mm; box-sizing: border-box; font-family: sans-serif; font-size: 14px; background: white;
            }
            .card, button, input, select, textarea, .pattern-container { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="ticketImpresion" style="display: none;">
        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px;">
            
            <img src="LOGO FA.jpg" style="max-width: 140px; margin-bottom: 5px;"> 
            
            <h2 style="margin: 0; font-size: 18px;">FA INSUMOS & SERVICIOS</h2>
            <p style="margin: 2px 0; font-size: 12px;">üìû WhatsApp: 264-567-4349</p> 
            <p style="margin: 2px 0; font-size: 12px;">üìç Ignacio de la Roza 110 (S), Va San Mart√≠n, Albard√≥n, San Juan</p>
            <p style="margin: 10px 0 5px 0; font-weight: bold; font-size: 15px; text-transform: uppercase;">Comprobante de Ingreso</p>
        </div>
        <p style="margin: 5px 0;"><strong>Fecha:</strong> <span id="tFecha"></span></p>
        <p style="margin: 5px 0;"><strong>Orden N¬∫:</strong> <span id="tNro" style="font-size: 18px; font-weight: bold;"></span></p>
        <p style="margin: 5px 0;"><strong>Cliente:</strong> <span id="tCliente"></span></p>
        <p style="margin: 5px 0;"><strong>Equipo:</strong> <span id="tEquipo"></span></p>
        <p style="margin: 5px 0;"><strong>Falla / Obs:</strong> <span id="tFalla"></span></p>
        <hr style="border-top: 1px dashed #333; margin: 10px 0;">
        <p style="margin: 5px 0;"><strong>Presupuesto / Tareas:</strong><br><pre id="tDetalle" style="font-family: sans-serif; font-size: 13px; margin: 5px 0; white-space: pre-wrap;"></pre></p>
        <div style="border-top: 1px solid #333; padding-top: 5px; margin-top: 10px;">
            <p style="margin: 5px 0;"><strong>Total:</strong> $<span id="tTotal"></span></p>
            <p style="margin: 5px 0;"><strong>Se√±a:</strong> $<span id="tSena"></span></p>
            <p style="margin: 5px 0; font-weight: bold; font-size: 16px;"><strong>Saldo a Pagar:</strong> $<span id="tSaldo"></span></p>
        </div>
        <p style="text-align: center; margin-top: 20px; font-size: 12px; font-style: italic;">¬°Gracias por confiar en nosotros!</p>
    </div>

    <div class="card">
        <h2>üìù Nuevo Ingreso & Presupuesto</h2>
        <div class="row">
            <input type="text" id="cliente" class="col" placeholder="Nombre y Apellido" required>
            <input type="tel" id="telefono" class="col" placeholder="Tel√©fono (Ej: 264...)" required>
        </div>
        <div class="row">
            <select id="tipoEquipo" class="col">
                <option value="CPU">CPU</option><option value="NOTEBOOK">Notebook</option>
                <option value="IMPRESORA">Impresora</option><option value="MONITOR">Monitor</option>
                <option value="CELULAR">Celular</option><option value="OTRO">Otro</option>
            </select>
            <input type="text" id="modelo" class="col" placeholder="Marca / Modelo">
        </div>
        
        <label>Seguridad del Equipo</label>
        <input type="text" id="clave" placeholder="Contrase√±a escrita (o dibuj√° el patr√≥n abajo)">
        
        <div class="pattern-container">
            <small style="color:#7f8c8d; display:block; margin-bottom:5px;">Dibuj√° el patr√≥n si es necesario (1 al 9)</small>
            <canvas id="patternCanvas" width="200" height="200"></canvas>
            <br>
            <button class="btn-clear-pattern" onclick="limpiarPatron()">Borrar Patr√≥n</button>
        </div>

        <textarea id="falla" placeholder="Falla / Observaciones..." style="margin-top:15px;"></textarea>
        
        <label>Accesorios que deja el cliente</label>
        <div class="row">
            <div class="col"><small>Cargador</small><select id="cableCorriente"><option value="NO">NO</option><option value="SI">S√ç</option></select></div>
            <div class="col"><small>Cable USB</small><select id="cableDatos"><option value="NO">NO</option><option value="SI">S√ç</option></select></div>
        </div>
        <input type="text" id="otroAccesorio" placeholder="Otros accesorios (Funda, chip, cartuchos...)">
        
        <label style="color: #8e44ad; border-top: 1px solid #ccc; padding-top: 15px; margin-top: 15px;">üí∞ Cotizaci√≥n Inicial (Opcional)</label>
        <div id="contenedorItems">
            <div class="row item-cotizacion">
                <input type="text" class="col desc" placeholder="Ej: Revisi√≥n T√©cnica / Cambio SSD">
                <input type="number" class="col precio" placeholder="Precio ($)" onkeyup="calcularTotal()">
            </div>
        </div>
        <button class="btn-add" onclick="agregarItem()">+ A√±adir otro √≠tem</button>
        <div class="row" style="margin-top: 15px;">
            <div class="col"><label>Total ($)</label><input type="number" id="presTotal" readonly style="background: #eee; font-weight: bold;"></div>
            <div class="col"><label>Se√±a ($)</label><input type="number" id="presSena" value="0" onkeyup="calcularTotal()"></div>
        </div>

        <button id="btnIngresar" onclick="ejecutarAccion('ingresar')">Registrar Ingreso e Imprimir</button>
        <div id="mensajeIngreso" class="status-box"></div>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Actualizar Estado</h2>
        <input type="text" id="actNro" placeholder="Nro de Reparaci√≥n (Ej: 1 o 0001)">
        <select id="actEstado">
            <option value="En Revisi√≥n">En Revisi√≥n</option>
            <option value="Esperando Repuesto">Esperando Repuesto</option>
            <option value="Reparado">Reparado (Listo para entregar)</option>
            <option value="Sin Soluci√≥n">Sin Soluci√≥n</option>
            <option value="Entregado">Entregado</option>
        </select>
        <textarea id="actNota" placeholder="Agregar nota al historial (Opcional)..."></textarea>
        <button id="btnActualizar" class="btn-update" onclick="ejecutarAccion('actualizar')">Guardar Avance</button>
    </div>

    <div class="card">
        <h2>üîç Consultar Servicio</h2>
        <div class="row">
            <input type="text" id="consNro" class="col" placeholder="Nro de Reparaci√≥n o Nombre">
            <button id="btnConsultar" class="col btn-search" style="margin-top: 5px;" onclick="ejecutarAccion('consultar')">Buscar</button>
        </div>
        <div id="mensajeConsulta" class="status-box"></div>
    </div>

    <script>
        // L√ìGICA DEL PATR√ìN DE DESBLOQUEO
        const canvas = document.getElementById('patternCanvas');
        const ctx = canvas.getContext('2d');
        const inputClave = document.getElementById('clave');
        
        let points = []; let path = []; let isDrawing = false; let currentX, currentY;

        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 3; col++) {
                points.push({ x: 40 + col * 60, y: 40 + row * 60, id: row * 3 + col + 1 });
            }
        }

        function drawPattern() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            points.forEach(p => {
                ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = path.includes(p.id) ? '#3498db' : '#bdc3c7'; ctx.fill();
            });
            if (path.length > 0) {
                ctx.beginPath(); ctx.strokeStyle = '#3498db'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                const first = points.find(p => p.id === path[0]); ctx.moveTo(first.x, first.y);
                for (let i = 1; i < path.length; i++) {
                    const pt = points.find(p => p.id === path[i]); ctx.lineTo(pt.x, pt.y);
                }
                if (isDrawing) ctx.lineTo(currentX, currentY); ctx.stroke();
            }
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDraw(e) { e.preventDefault(); isDrawing = true; path = []; inputClave.value = ""; moveDraw(e); }
        function moveDraw(e) {
            if (!isDrawing) return; e.preventDefault(); const pos = getPos(e); currentX = pos.x; currentY = pos.y;
            points.forEach(p => {
                if (!path.includes(p.id)) {
                    if (Math.hypot(p.x - currentX, p.y - currentY) < 20) path.push(p.id);
                }
            });
            drawPattern();
        }
        function endDraw(e) { e.preventDefault(); isDrawing = false; drawPattern(); if (path.length > 0) inputClave.value = "Patr√≥n: " + path.join("-"); }
        function limpiarPatron() { path = []; inputClave.value = ""; drawPattern(); }

        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', moveDraw); window.addEventListener('mouseup', () => { if(isDrawing) endDraw({preventDefault:()=>{}}); });
        canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', moveDraw, {passive: false}); window.addEventListener('touchend', () => { if(isDrawing) endDraw({preventDefault:()=>{}}); });
        drawPattern();


        // COMUNICACI√ìN CON GOOGLE APPS SCRIPT
        const URL_API = "https://script.google.com/macros/s/AKfycbx205tJR-sW11Z1gzkwu1Ln_vcZSAmqstEwfMKteXAeTf35nHsOncciqOEqtLEAu-01/exec"; 

        function agregarItem() {
            const div = document.createElement('div'); div.className = 'row item-cotizacion';
            div.innerHTML = `<input type="text" class="col desc" placeholder="Detalle"><input type="number" class="col precio" placeholder="Precio ($)" onkeyup="calcularTotal()"><button class="btn-del" onclick="this.parentElement.remove(); calcularTotal()">X</button>`;
            document.getElementById('contenedorItems').appendChild(div);
        }

        function calcularTotal() {
            let total = 0;
            document.querySelectorAll('.precio').forEach(input => { total += parseFloat(input.value) || 0; });
            document.getElementById('presTotal').value = total;
        }

        function abrirWhatsApp(telefono, cliente, equipo, estado, saldo) {
            let numeroLimpio = telefono.replace(/\D/g,'');
            if (!numeroLimpio.startsWith("549")) numeroLimpio = "549" + numeroLimpio;
            let texto = `Hola ${cliente}! Te escribimos de FA Insumos & Servicios. Te avisamos que tu equipo (${equipo}) se encuentra en estado: *${estado}*.`;
            if (saldo > 0) texto += ` El saldo a abonar es de $${saldo}.`;
            texto += ` ¬°Cualquier consulta estamos a disposici√≥n!`;
            window.open(`https://wa.me/${numeroLimpio}?text=${encodeURIComponent(texto)}`, '_blank');
        }

        async function ejecutarAccion(tipo) {
            let idBoton = tipo === 'ingresar' ? 'btnIngresar' : (tipo === 'actualizar' ? 'btnActualizar' : 'btnConsultar');
            const btn = document.getElementById(idBoton);
            const textoOriginal = btn.innerText;
            btn.disabled = true; btn.innerText = "Procesando...";

            let datos = { accion: tipo };

            if (tipo === 'ingresar') {
                datos.cliente = document.getElementById('cliente').value;
                datos.telefono = document.getElementById('telefono').value;
                datos.tipoEquipo = document.getElementById('tipoEquipo').value;
                datos.modelo = document.getElementById('modelo').value;
                datos.clave = document.getElementById('clave').value || "Ninguna";
                datos.falla = document.getElementById('falla').value || "Sin observaciones";
                datos.cableCorriente = document.getElementById('cableCorriente').value;
                datos.cableDatos = document.getElementById('cableDatos').value;
                datos.otroAccesorio = document.getElementById('otroAccesorio').value || "Ninguno";
                
                datos.total = document.getElementById('presTotal').value || 0;
                datos.sena = document.getElementById('presSena').value || 0;
                let detalleStr = "";
                document.querySelectorAll('.item-cotizacion').forEach(item => {
                    let desc = item.querySelector('.desc').value; let prec = item.querySelector('.precio').value;
                    if(desc && prec) detalleStr += `- ${desc}: $${prec}\n`;
                });
                datos.detalle = detalleStr || "Sin cotizar";

                if(!datos.cliente || !datos.telefono) { alert("Nombre y tel√©fono obligatorios."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            } 
            else if (tipo === 'actualizar') {
                datos.id = document.getElementById('actNro').value;
                datos.estado = document.getElementById('actEstado').value;
                datos.nota = document.getElementById('actNota').value;
                if(!datos.id) { alert("Ingresa Nro."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            } 
            else if (tipo === 'consultar') {
                datos.id = document.getElementById('consNro').value;
                if(!datos.id) { alert("Ingresa Nro o Nombre."); btn.disabled = false; btn.innerText = textoOriginal; return; }
            }

            try {
                const response = await fetch(URL_API, { method: 'POST', body: JSON.stringify(datos) });
                const res = await response.json();
                
                if (res.error) alert(res.error);
                else if (tipo === 'ingresar') {
                    // Llenar e imprimir ticket original
                    document.getElementById('tFecha').innerText = res.fecha;
                    document.getElementById('tNro').innerText = res.nroAsignado;
                    document.getElementById('tCliente').innerText = datos.cliente;
                    document.getElementById('tEquipo').innerText = datos.tipoEquipo + " " + datos.modelo;
                    document.getElementById('tFalla').innerText = datos.falla;
                    document.getElementById('tDetalle').innerText = datos.detalle;
                    document.getElementById('tTotal').innerText = datos.total;
                    document.getElementById('tSena').innerText = datos.sena;
                    document.getElementById('tSaldo').innerText = datos.total - datos.sena;
                    
                    const caja = document.getElementById('mensajeIngreso');
                    caja.style.display = 'block'; caja.style.background = '#d4edda';
                    caja.innerHTML = `‚úÖ ¬°Ingresado!<br><span class="nro-destacado">N¬∫ ${res.nroAsignado}</span>`;
                    
                    document.getElementById('ticketImpresion').style.display = 'block';
                    window.print();
                    document.getElementById('ticketImpresion').style.display = 'none';

                    // Limpiar Formulario
                    document.querySelectorAll('input[type="text"], input[type="tel"], textarea').forEach(el => el.value = '');
                    document.querySelectorAll('.item-cotizacion').forEach((el, index) => { if(index > 0) el.remove(); });
                    document.getElementById('presTotal').value = ''; document.getElementById('presSena').value = '0';
                    document.getElementById('cableCorriente').value = "NO"; document.getElementById('cableDatos').value = "NO";
                    limpiarPatron();

                } else if (tipo === 'actualizar') {
                    alert(res.mensaje);
                    document.getElementById('actNro').value = ''; document.getElementById('actNota').value = '';
                } else if (tipo === 'consultar') {
                    const caja = document.getElementById('mensajeConsulta');
                    caja.style.display = 'block';
                    
                    let saldo = res.total - res.sena;
                    let finanzasHTML = "";
                    if(res.total > 0) {
                        finanzasHTML = `<div class="finanzas-box">
                            <strong>Cotizaci√≥n:</strong><br><pre style="margin:5px 0; font-family:sans-serif;">${res.detalle}</pre><hr style="border:0; border-top:1px solid #1abc9c;">
                            <b>Total:</b> $${res.total} | <b>Se√±a:</b> $${res.sena} <br>
                            <b style="color:#c0392b; font-size:16px;">Restante a Pagar: $${saldo}</b></div>`;
                    }

                    let badgeArchivado = res.estado === "Entregado" 
                        ? `<div style="background:#f39c12; color:white; padding:5px; text-align:center; font-size:12px; margin-bottom:10px; border-radius:3px; font-weight:bold;">‚ö†Ô∏è ESTE EQUIPO YA FUE ENTREGADO AL CLIENTE</div>` : ``;

                    // Pre-cargar datos en el ticket oculto por si hace clic en "Reimprimir"
                    let fechaMostrada = res.fecha;
                    if(res.fecha && res.fecha.includes("T")) {
                        let f = new Date(res.fecha);
                        fechaMostrada = f.toLocaleDateString('es-AR');
                    }
                    
                    document.getElementById('tFecha').innerText = fechaMostrada;
                    document.getElementById('tNro').innerText = res.nroAsignado;
                    document.getElementById('tCliente').innerText = res.cliente;
                    document.getElementById('tEquipo').innerText = res.equipo;
                    document.getElementById('tFalla').innerText = res.falla;
                    document.getElementById('tDetalle').innerText = res.detalle;
                    document.getElementById('tTotal').innerText = res.total;
                    document.getElementById('tSena').innerText = res.sena;
                    document.getElementById('tSaldo').innerText = saldo;

                    caja.innerHTML = `
                        ${badgeArchivado}
                        <div style="background: #34495e; color: white; padding: 5px; text-align: center; border-radius: 3px; margin-bottom: 10px;">
                            <b>REPARACI√ìN N¬∫ ${res.nroAsignado}</b>
                        </div>
                        <b>Cliente:</b> ${res.cliente} <br>
                        <b>Equipo:</b> ${res.equipo} <br>
                        <b>Estado Actual:</b> <span style="color:#d32f2f; font-weight:bold;">${res.estado}</span> <br>
                        <b>Clave/Patr√≥n:</b> ${res.clave || "Ninguna"} <br>
                        ${finanzasHTML}
                        <div class="historial-texto">${res.historial}</div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button style="background: #25D366; color: white; margin: 0; padding: 10px;" onclick="abrirWhatsApp('${res.telefono}', '${res.cliente}', '${res.equipo}', '${res.estado}', ${saldo})">üì≤ WhatsApp</button>
                            <button style="background: #34495e; color: white; margin: 0; padding: 10px;" onclick="reimprimirTicket()">üñ®Ô∏è Reimprimir Ticket</button>
                        </div>
                    `;
                }
            } catch (error) {
                alert("Error de conexi√≥n. Revisa la URL.");
            } finally {
                btn.disabled = false; btn.innerText = textoOriginal;
            }
        }

        // FUNCI√ìN PARA REIMPRIMIR DESDE LA CONSULTA
        function reimprimirTicket() {
            document.getElementById('ticketImpresion').style.display = 'block';
            window.print();
            document.getElementById('ticketImpresion').style.display = 'none';
        }
    </script>
</body>

</html>
